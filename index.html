<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>商业POI地图</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      html, body { height: 100%; margin: 0; }
      #app { height: 100%; display: grid; grid-template-rows: auto 1fr; }
      .toolbar { padding: 10px; background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.1); display: grid; grid-template-columns: 1fr auto auto auto auto auto; gap: 8px; align-items: center; position: relative; z-index: 2000; }
      .toolbar input, .toolbar select, .toolbar button { height: 34px; padding: 0 8px; font-size: 14px; }
      .input-wrap { position: relative; }
      .suggest { position: absolute; left: 0; right: 0; top: 38px; background: rgba(255,255,255,0.98); border: 1px solid #e0e0e0; border-radius: 6px; box-shadow: 0 8px 24px rgba(0,0,0,0.18); max-height: 260px; overflow: auto; z-index: 10000; }
      .suggest::-webkit-scrollbar { width: 8px; }
      .suggest::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
      .suggest-item { padding: 8px 10px; font-size: 13px; cursor: pointer; }
      .suggest-item:hover, .suggest-item.active { background: #f5f5f5; }
      .input-wrap.loading::after { content: ""; position: absolute; right: 10px; top: 50%; width: 16px; height: 16px; margin-top: -8px; border-radius: 50%; border: 2px solid #999; border-top-color: transparent; animation: spin .8s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg); } }
      #map { height: 100%; }
      .pill { padding: 0 10px; height: 28px; display: inline-flex; align-items: center; border-radius: 14px; background: #f5f5f5; font-size: 12px; }
      .legend { position: absolute; right: 12px; bottom: 12px; background: #fff; padding: 8px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); font-size: 12px; }
      .legend-item { display: flex; align-items: center; gap: 6px; margin: 4px 0; }
      .legend-swatch { width: 14px; height: 14px; border-radius: 50%; }
      .side { position: absolute; left: 12px; bottom: 12px; max-height: 40%; width: 320px; overflow: auto; background: #fff; padding: 8px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); font-size: 12px; z-index: 5000; }
      .poi-item { padding: 6px 4px; border-bottom: 1px solid #eee; }
      .poi-item:last-child { border-bottom: none; }
    </style>
  </head>
  <body>
      <div id="app">
        <div class="toolbar">
          <div class="input-wrap">
            <input id="placeInput" type="text" placeholder="输入地点，如 北京 紫金数码园 4号楼" />
            <div id="placeSuggest" class="suggest" hidden></div>
          </div>
          <input id="radiusInput" type="number" min="100" step="100" value="1000" />
          <select id="styleSelect">
            <option value="osm">OSM 标准</option>
            <option value="carto-light">Carto Light</option>
            <option value="carto-dark">Carto Dark</option>
          </select>
          <select id="iconSelect">
            <option value="by-type">按类型着色</option>
            <option value="red">红色图标</option>
            <option value="blue">蓝色图标</option>
            <option value="green">绿色图标</option>
          </select>
          <button id="searchBtn">确定</button>
          <span id="count" class="pill">POI: 0</span>
        </div>
      <div id="map"></div>
      <div class="legend" id="legend"></div>
      <div class="side" id="side"></div>
    </div>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    ></script>
    <script>
      // 可选：通过URL ?backend=https://your-app.vercel.app 指定后端代理基地址
      const backendBaseParam = new URLSearchParams(location.search).get('backend') || '';
      const backendProvided = !!backendBaseParam;
      let backendBase = backendBaseParam ? backendBaseParam.replace(/\/$/, '') : '';
      try {
        if (!backendBase && location.hostname && location.hostname !== 'localhost') {
          backendBase = location.origin;
        }
      } catch (_) {}
      // 移除调试状态逻辑；运行时统一按 backendBase 优先走后端
      const tileSources = {
        osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }),
        'carto-light': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a> & OpenStreetMap' }),
        'carto-dark': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a> & OpenStreetMap' })
      };

      const map = L.map('map', { center: [39.9042, 116.4074], zoom: 13, layers: [tileSources.osm] });
      let currentTile = tileSources.osm;
      let circleLayer = null;
      let markerLayer = L.layerGroup().addTo(map);

      function svgIcon(color) {
        const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30"><path d="M15 2c5.523 0 10 4.477 10 10 0 8-10 16-10 16S5 20 5 12C5 6.477 9.477 2 15 2z" fill="${color}"/><circle cx="15" cy="12" r="4" fill="#fff"/></svg>`;
        const url = 'data:image/svg+xml;base64,' + btoa(svg);
        return L.icon({ iconUrl: url, iconSize: [30, 30], iconAnchor: [15, 28], popupAnchor: [0, -26] });
      }

      const colors = { default: '#d81b60', red: '#d81b60', blue: '#2962ff', green: '#2e7d32' };
      let currentIcon = svgIcon(colors.red);
      let iconMode = 'by-type';

      const typeLegend = [
        { key: 'shop', name: '商店/购物', color: '#2962ff' },
        { key: 'food', name: '餐饮', color: '#d81b60' },
        { key: 'service', name: '生活服务/金融', color: '#2e7d32' }
      ];
      function renderLegend() {
        const el = document.getElementById('legend');
        el.innerHTML = typeLegend.map(i => `<div class="legend-item"><span class="legend-swatch" style="background:${i.color}"></span>${i.name}</div>`).join('');
      }
      renderLegend();

      async function geocodePlaceAMap(q) {
        let url = '';
        if (backendBase) {
          url = `${backendBase}/api/amap-place-text?keywords=${encodeURIComponent(q)}`;
        } else {
          const key = localStorage.getItem('amap_key') || new URLSearchParams(location.search).get('amap_key') || '';
          if (!key) throw new Error('请填写高德key');
          url = `https://restapi.amap.com/v3/place/text?key=${encodeURIComponent(key)}&keywords=${encodeURIComponent(q)}&citylimit=false&offset=1&page=1&extensions=base`;
        }
        const res = await fetch(url);
        if (!res.ok) throw new Error('高德地理搜索失败');
        const data = await res.json();
        if (data.status !== '1' || !data.pois || !data.pois.length) throw new Error('高德未找到该地点');
        const p = data.pois[0];
        const [lng, lat] = (p.location || '').split(',').map(Number);
        if (!isFinite(lat) || !isFinite(lng)) throw new Error('高德地点无坐标');
        return { lat, lon: lng, displayName: p.name };
      }

      async function suggestPlaces(q) {
        let url = '';
        if (backendBase) {
          url = `${backendBase}/api/amap-place-text?keywords=${encodeURIComponent(q)}&offset=8`;
        } else {
          const key = localStorage.getItem('amap_key') || new URLSearchParams(location.search).get('amap_key') || '';
          if (!key) return [];
          url = `https://restapi.amap.com/v3/place/text?key=${encodeURIComponent(key)}&keywords=${encodeURIComponent(q)}&citylimit=false&offset=8&page=1&extensions=base`;
        }
        const res = await fetch(url);
        if (!res.ok) return [];
        const data = await res.json();
        if (data.status !== '1') return [];
        return (data.pois || []).map(p => {
          const [lng, lat] = (p.location || '').split(',').map(Number);
          return { name: p.name, lat, lon: lng };
        }).filter(i => isFinite(i.lat) && isFinite(i.lon));
      }

      async function fetchPOIsAMap(lat, lon, radius) {
        const types = encodeURIComponent('餐饮服务|购物服务|生活服务|金融保险服务');
        const offset = 50;
        const maxPages = 10;
        let page = 1;
        const out = [];
        const seen = new Set();
        while (page <= maxPages) {
          let url = '';
          if (backendBase) {
            url = `${backendBase}/api/amap-place-around?location=${lon},${lat}&radius=${radius}&types=${types}&sortrule=distance&offset=${offset}&page=${page}`;
          } else {
            const key = localStorage.getItem('amap_key') || new URLSearchParams(location.search).get('amap_key') || '';
            if (!key) throw new Error('请填写高德 key');
            url = `https://restapi.amap.com/v3/place/around?key=${encodeURIComponent(key)}&location=${lon},${lat}&radius=${radius}&types=${types}&output=json&sortrule=distance&offset=${offset}&page=${page}`;
          }
          const res = await fetch(url);
          if (!res.ok) break;
          const data = await res.json();
          if (data.status !== '1') break;
          const pois = data.pois || [];
          for (const p of pois) {
            const pos = p.location ? p.location.split(',').reverse().map(Number) : null;
            const name = p.name || '';
            const keySig = `${name}|${p.location || ''}`;
            if (seen.has(keySig)) continue;
            seen.add(keySig);
            out.push({ type: 'amap', pos, name, category: p.type, raw: p });
          }
          if (pois.length < offset) break;
          page++;
        }
        return out;
      }

      function jsonp(url) {
        return new Promise((resolve, reject) => {
          const cb = '__bd_cb_' + Math.random().toString(36).slice(2);
          url += (url.includes('?') ? '&' : '?') + 'callback=' + cb;
          const s = document.createElement('script');
          s.src = url;
          s.onerror = () => { delete window[cb]; reject(new Error('JSONP请求失败')); };
          window[cb] = (data) => { delete window[cb]; resolve(data); };
          document.body.appendChild(s);
        });
      }

      async function fetchPOIsBaidu(lat, lon, radius, ak) {
        if (!ak) throw new Error('请填写百度 ak');
        const query = encodeURIComponent('美食$商场$超市$银行$药店$酒店$咖啡$便利店$购物$餐饮$服务');
        const url = backendBase ? `${backendBase}/api/baidu/place-search?query=${query}&location=${lat},${lon}&radius=${radius}` : `https://api.map.baidu.com/place/v2/search?query=${query}&location=${lat},${lon}&radius=${radius}&output=json&scope=2&ak=${encodeURIComponent(ak)}`;
        const data = backendBase ? await (await fetch(url)).json() : await jsonp(url);
        if (data.status !== 0) throw new Error(data.message || '百度POI检索失败');
        return (data.results || []).map(r => ({
          type: 'baidu',
          pos: r.location ? [r.location.lat, r.location.lng] : null,
          name: r.name,
          category: r.category || r.tags || '',
          raw: r
        }));
      }

      function classify(e) {
        if (e && e.type === 'amap') {
          const cat = e.category || '';
          if (/餐饮/.test(cat)) return 'food';
          if (/购物/.test(cat)) return 'shop';
          if (/生活服务|金融/.test(cat)) return 'service';
          return 'service';
        }
        return 'service';
      }

      function colorForType(type) {
        if (type === 'shop') return '#2962ff';
        if (type === 'food') return '#d81b60';
        return '#2e7d32';
      }

      function iconForType(type) {
        return svgIcon(colorForType(type));
      }

      function centerOf(e) {
        if (e.type === 'amap') return e.pos || null;
        return null;
      }

      function distanceMeters(a, b) {
        const toRad = d => d * Math.PI / 180;
        const R = 6371000;
        const dLat = toRad(b[0] - a[0]);
        const dLon = toRad(b[1] - a[1]);
        const lat1 = toRad(a[0]);
        const lat2 = toRad(b[0]);
        const sinDLat = Math.sin(dLat / 2);
        const sinDLon = Math.sin(dLon / 2);
        const h = sinDLat * sinDLat + Math.cos(lat1) * Math.cos(lat2) * sinDLon * sinDLon;
        return 2 * R * Math.asin(Math.sqrt(h));
      }

      function clearResults() {
        markerLayer.clearLayers();
        if (circleLayer) { map.removeLayer(circleLayer); circleLayer = null; }
        document.getElementById('count').textContent = 'POI: 0';
        document.getElementById('side').innerHTML = '';
      }

      async function runSearch(preset) {
        const place = document.getElementById('placeInput').value.trim();
        const radius = parseInt(document.getElementById('radiusInput').value, 10) || 1000;
        if (!place) return;
        clearResults();
        try {
          setInputLoading(true);
          let geo = null;
          if (preset) {
            geo = { lat: preset.lat, lon: preset.lon, displayName: preset.name };
          } else {
            geo = await geocodePlaceAMap(place);
          }
          const center = [geo.lat, geo.lon];
          map.setView(center, 15);
          circleLayer = L.circle(center, { radius, color: '#1976d2', fillColor: '#1976d2', fillOpacity: 0.08, weight: 1 }).addTo(map);
          let elements = [];
          elements = await fetchPOIsAMap(geo.lat, geo.lon, radius);
          const filtered = [];
          const centerPt = [geo.lat, geo.lon];
          elements.forEach(e => {
            const pos = centerOf(e);
            if (!pos) return;
            const dist = distanceMeters(centerPt, pos);
            if (dist > radius) return;
            const type = classify(e);
            const icon = iconMode === 'by-type' ? iconForType(type) : currentIcon;
            const name = e.name || (e.tags && (e.tags.name || e.tags['name:zh'] || e.tags.brand || e.tags.operator)) || '未命名';
            const m = L.marker(pos, { icon }).addTo(markerLayer);
            m.bindPopup(`<strong>${name}</strong><br/>类型：${type}<br/>距离：${Math.round(dist)}m`);
            filtered.push({ name, type, dist });
          });
          filtered.sort((a, b) => a.dist - b.dist);
          document.getElementById('count').textContent = `POI: ${filtered.length}`;
          document.getElementById('side').innerHTML = filtered.map(i => `<div class="poi-item"><strong>${i.name}</strong><br/>${i.type} · ${Math.round(i.dist)}m</div>`).join('');
          setInputLoading(false);
        } catch (err) {
          setInputLoading(false);
          alert(err.message || '发生错误');
        }
      }

      document.getElementById('searchBtn').addEventListener('click', () => runSearch());
      const placeInput = document.getElementById('placeInput');
      const suggestEl = document.getElementById('placeSuggest');
      const inputWrap = placeInput.parentElement;
      const setInputLoading = (b) => { inputWrap.classList.toggle('loading', !!b); };
      let suggestTimer = null;
      let suggestIndex = -1;
      let suggestData = [];
      placeInput.addEventListener('input', () => {
        const q = placeInput.value.trim();
        if (suggestTimer) clearTimeout(suggestTimer);
        if (q.length < 2) { setInputLoading(false); suggestEl.hidden = true; suggestEl.innerHTML = ''; suggestData = []; suggestIndex = -1; return; }
        suggestTimer = setTimeout(async () => {
          setInputLoading(true);
          const list = await suggestPlaces(q);
          suggestData = list;
          suggestIndex = -1;
          if (!list.length) { suggestEl.hidden = true; suggestEl.innerHTML = ''; return; }
          suggestEl.innerHTML = list.map((i, idx) => `<div class="suggest-item" data-idx="${idx}">${i.name}</div>`).join('');
          suggestEl.hidden = false;
          setInputLoading(false);
        }, 250);
      });
      placeInput.addEventListener('keydown', e => {
        if (suggestEl.hidden) { if (e.key === 'Enter') runSearch(); return; }
        const max = suggestData.length;
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          suggestIndex = (suggestIndex + 1) % max;
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          suggestIndex = (suggestIndex - 1 + max) % max;
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (suggestIndex >= 0 && suggestIndex < max) {
            const item = suggestData[suggestIndex];
            placeInput.value = item.name;
            suggestEl.hidden = true;
            runSearch(item);
          } else {
            runSearch();
          }
          return;
        } else if (e.key === 'Escape') {
          e.preventDefault();
          suggestEl.hidden = true;
          return;
        } else {
          return;
        }
        Array.from(suggestEl.children).forEach((el, idx) => {
          if (idx === suggestIndex) el.classList.add('active'); else el.classList.remove('active');
        });
      });
      suggestEl.addEventListener('mousedown', e => {
        const target = e.target.closest('.suggest-item');
        if (!target) return;
        const idx = parseInt(target.getAttribute('data-idx'), 10);
        if (isNaN(idx)) return;
        const item = suggestData[idx];
        placeInput.value = item.name;
        suggestEl.hidden = true;
        runSearch(item);
      });

      document.getElementById('styleSelect').addEventListener('change', e => {
        const v = e.target.value;
        if (currentTile) map.removeLayer(currentTile);
        currentTile = tileSources[v] || tileSources.osm;
        currentTile.addTo(map);
      });

      document.getElementById('iconSelect').addEventListener('change', e => {
        const v = e.target.value;
        if (v === 'by-type') {
          iconMode = 'by-type';
        } else {
          iconMode = 'custom';
          currentIcon = svgIcon(colors[v] || colors.default);
        }
      });

      // 移除数据源选择与密钥输入；在有后端代理时不需要任何密钥输入
      // 本地调试可通过 URL ?amap_key=xxx 注入临时密钥
    </script>
  </body>
  </html>
